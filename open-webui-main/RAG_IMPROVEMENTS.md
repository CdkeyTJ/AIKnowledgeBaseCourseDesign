# RAG系统改进说明

## 问题解决

### 1. 知识库重启后丢失问题 ✅ 已解决

**原因分析：**
- 所有数据都存储在内存中（`user_kbs` 和 `vector_stores` 字典）
- 应用重启后内存数据丢失

**解决方案：**
- 实现了持久化存储机制
- 知识库元数据保存到 `rag_storage/metadata.json`
- 向量存储保存到 `rag_storage/vectors/` 目录
- 应用启动时自动加载已保存的数据

**存储结构：**
```
rag_storage/
├── metadata.json          # 知识库元数据
└── vectors/               # 向量存储文件
    ├── user1_kb1.pkl
    ├── user1_kb2.pkl
    └── user2_kb1.pkl
```

### 2. 检索不到内容问题 ✅ 已解决

**原因分析：**
- 用户输入"帮我出题"等通用词汇
- 这些词汇无法匹配到专业内容
- 向量检索策略不够智能

**解决方案：**
- 实现了智能关键词提取
- 过滤通用词汇（如"帮我"、"出题"、"请"等）
- 提取专业关键词进行检索
- 如果关键词检索失败，回退到原问题检索

**关键词提取示例：**
```
输入: "帮我出题关于细胞膜的知识"
提取: "细胞膜 知识"
过滤: "帮我 出题 关于 的" (通用词汇)
```

## 新增功能

### 1. 知识库删除功能
- 支持删除整个知识库
- 自动清理相关文件和向量存储
- 持久化更新元数据

### 2. 持久化存储
- 自动保存知识库元数据
- 自动保存向量存储
- 应用重启后数据不丢失

### 3. 智能检索优化
- 关键词提取和过滤
- 多级检索策略
- 详细的检索日志

## 使用方法

### 1. 创建知识库
```bash
POST /api/v1/rag/knowledge-bases
{
    "name": "生物学知识库",
    "description": "包含细胞生物学、分子生物学等知识"
}
```

### 2. 上传文档
```bash
POST /api/v1/rag/knowledge-bases/{kb_id}/documents
# 上传PDF或TXT文件
```

### 3. 查询知识库
```bash
POST /api/v1/rag/knowledge-bases/{kb_id}/query
{
    "question": "帮我出题关于细胞膜的知识",
    "top_k": 3
}
```

### 4. 删除知识库
```bash
DELETE /api/v1/rag/knowledge-bases/{kb_id}
```

## 技术实现

### 1. 持久化存储
- `save_metadata()`: 保存元数据到JSON文件
- `load_metadata()`: 从文件加载元数据
- `save_vector_store()`: 保存向量存储到pickle文件
- `load_vector_store()`: 从文件加载向量存储

### 2. 智能检索
- `extract_keywords()`: 提取专业关键词
- 通用词汇过滤
- 多级检索策略

### 3. 数据管理
- 自动创建存储目录
- 启动时初始化数据
- 异常处理和错误恢复

## 注意事项

1. **存储路径**：确保应用有写入权限到 `rag_storage` 目录
2. **文件大小**：向量存储文件可能较大，注意磁盘空间
3. **性能影响**：启动时需要加载所有向量存储，可能影响启动速度
4. **数据备份**：建议定期备份 `rag_storage` 目录

## 未来改进

1. **数据库存储**：将内存存储迁移到数据库
2. **向量数据库**：使用专业的向量数据库（如Pinecone、Weaviate）
3. **缓存机制**：添加Redis缓存提高性能
4. **异步处理**：文档上传和向量化异步处理
5. **批量操作**：支持批量文档上传和删除
